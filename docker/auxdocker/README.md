# auxdocker: помогалка для разворачивания проектов локально в docker

## Создание своей сборки под проект

1. Создать папку проекта, например, `myproject/`
2. Внутри проекта создать папочку для конфигов докера (например, `myproject/aux/docker/`).
3. Добавить сервис (mysql, php-apache и пр.):
   1. Скопировать его в папочку.
   2. Скопировать в него его аддоны (если есть/требуется).
   3. Доработать напильником Dockerfile сервиса.
   4. В основной папочке сделать .env.ИМЯ_СЕРВИСА.override для оверрайда значений .env сервиса (если нужно) (применяется билдером).
4. Повторить для прочих сервисов, которые нужны в сборке.
5. Повторить для сервиса _base (нужен обязательно).
   1. Для _base как минимум сделать .env._base.override с `SERVICES_PATH` - путь от корня проекта до нашей папочки (например, `aux/docker/`). 
6. Рядом с сервисами положить `build-conf.sh`.
7. Запустить его. Он создаст `.env.template` и `docker-compose.yml.template`.
8. Изучить конфиги, доработать по необходимости либо сами получившиеся конфиги, либо `.env.*.override` (на основе которых генерировались конфиги). При необходимости перезапустить `build-conf.sh`. Таким образом создать итоговые `.env` и `docker-compose.yml`.
9. Положить итоговые `.env` и `docker-compose.yml` конфиги в место, где они будут жить (обычно корень проекта).
10. `docker-compose up -d`
11. При необходимости скорректировать исходники сервисов, пересобрать, дорабатывать до готовности.

В результате должен получиться набор файлов, требующий минимум действий для запуска проекта (см. "Минимум действий для запуска готовой сборки проекта").

## Минимум действий для запуска готовой сборки проекта
 
1. Создать папку проекта.
2. Положить туда папочку с готовой сборкой конфигов докера (например, в `aux/docker`).
3. Подправить `aux/docker/.env._base.override`, указав там локальный IP для данного проекта.
4. Сгенерировать `.env` и `docker-compose.yml` с помощью `build-conf.sh`
5. Положить их в корень проекта.
6. Положить сами файлы проекта, скажем, в `./src`. 
7. `docker-compose up -d`
8. Готово.

## Управление сервисами

Сервисы поддерживают для управления скрипт `...docker/имя_сервиса/имя_сервиса`, например, `aux/docker/mysql/mysql`. Действие скрипта по умолчанию при запуске без аргументов зависит от сервиса. 

Как правило, сервисы поддерживают команды:

 * `docker/myservice/myservice root` - вход в контейнер от root
 * `docker/myservice/myservice rebuild` - пересборка сервиса
 * `docker/myservice/myservice restert` - рестарт сервиса

Сервисы могут поддерживать дополнительные команды, см. скрипт конкретного сервиса для дополнительной информации.

## Решение проблем с конфигами

Спасибо https://stackoverflow.com/a/50166314/1775065

```
docker cp container_web_1:/etc/apache2/conf-enabled/some-settings.conf .
# ... edit some-settings.conf ...
docker cp some-settings.conf container_web_1:/etc/apache2/conf-enabled/some-settings.conf
```

## См. также

* https://github.com/frontid/dockerizer
* include+ https://github.com/edrevo/dockerfile-plus
