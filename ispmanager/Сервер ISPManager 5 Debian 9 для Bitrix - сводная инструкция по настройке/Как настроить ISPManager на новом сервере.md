# Как настроить ISPManager на новом сервере

---

Ситуация: ISPManager, панель уже установлена.

Нужно настроить ISPManager и подготовить его к размещению сайтов.

Базовая инструкция здесь [Сервер ISPManager 5 Debian 9 для Bitrix - сводная инструкция по настройке](README.md)

Остальные ответы - дополнительные и не являются самостоятельными полными инструкциями.

---

Это первый этап настройки сервера с ISPManager, еще до создания на нем аккаунтов пользователя и сайтов. Создание пользователей и сайтов здесь на рассматриваем, только тестирование и первоначальную подготовительную настройку.

# 10. Тестирование сервера <sup><sup>(это 1-й пункт, просто нумерация начинается с 10)</sup></sup>

1. Зайти под root.
2. Проверить, что это Debian 9 `cat /etc/issue`
3. Проверить скорость работы диска (команды взяты отсюда https://www.cyberciti.biz/faq/howto-linux-unix-test-disk-performance-with-dd-command/ )

```
# на железный сервер (железный сервер, диск ssd без RAID) выполняется за 2.5 с
# на vds firstvds тариф с диском HDD+SSD без RAID 5-10 с
# vds firstvds (1 час после установки) HDD+SSD KVM 4cpu/4G 11.5 с
# vds firstvds (20 минут после установки) HDD+SSD KVM 4cpu/4G 4.9 c
# vds firstvds (чуть > 60 мин) HDD+SSD KVM 1cpu/1G 2.57/2.26/2.38 с !!! 512M вместо 1G!!! ~220 MB/s
# vds firstvds (3 недели после установки, сервер не использовался)  HDD+SSD? KVM? 6cpu/6Gb 11/6/8/11/16 с, ~100 MB/s
# vds firstvds (15 мин после установки)  NVMe KVM 2cpu/8Gb 5.0/5.7/4.6/5.6 с, ~200 MB/s
dd if=/dev/zero of=/tmp/test1.img bs=1G count=1 oflag=dsync ; rm -f /tmp/test1.img

# на железный сервер (железный сервер, диск ssd без RAID) выполняется за 0.8 с
# на vds firstvds тариф с диском HDD+SSD без RAID 4-5 с
# # vds firstvds (1 час после установки) HDD+SSD KVM 4cpu/4G 29/33/25/23с
# vds firstvds (20 минут после установки) KVM 4cpu/4G HDD+SSD 1.61 c
# vds firstvds (чуть > 60 мин) HDD+SSD KVM 1cpu/1G 4.4/4.5/5.1/3.8 с ~110 kB/s
# vds firstvds (3 недели после установки, сервер не использовался)  HDD+SSD? KVM? 6cpu/6Gb 6/3/4/12/6 с, ~100 kB/s
# vds firstvds (15 мин после установки)  NVMe KVM 2cpu/8Gb 0.4/0.4/0.4 с, 1.2 MB/s
dd if=/dev/zero of=/tmp/test2.img bs=512 count=1000 oflag=dsync ; rm -f /tmp/test2.img
```

Если показатели сильно хуже, возможно, выбран не тот тариф хостинга (например, HDD вместо HDD+SSD/SSD) или плохой хостинг. Но статистики пока мало, поэтому пока тестируем разные серверы и записываем сюда результаты. По  накоплении статистики будем делать выводы. Также наблюдения показывают, что сразу после установки сервера показатели могут быть плохие, а потом выправляются. Поэтому нужно писать имя сервера, тариф, сколько прошло с момента установки сервера, время теста в секундах. 

4. Проверить, что стоит mariadb
```
mysql -u root
# должен быть вход без пароля
\s
# должно быть написано Distrib 10.1.37-MariaDB или новее
```

# 20. Тестирование прошло успешно?

> Если какие-то пункты тестирования не пройдены, сервер **НЕЛЬЗЯ ИСПОЛЬЗОВАТЬ** для размещения сайтов.

# 30. Установка и настройка софта

0. Проверить `/etc/hosts`. Например, на FirstVDS при установке сервера туда прописывается приватный ip для доменного имени, которое указывалось при создании виртуального сервера, например:

```
172.31.16.9     my-site.ru my-site
#                  ^^^ -----<------<------<-- вот это проблема
```

Это потом мешает установке SSL на это имя, работе Битрикса. Поэтому полное доменное имя оттуда убираем, оставляем только имя хоста:

```
172.31.16.9     my-site
```

1. Поставить базовый софт:
```
apt install mc tmux git
```
2. Настроить git (так и вводить, переменные сами раскроются):
```
git config --global user.name $USER
git config --global user.email $USER@$HOSTNAME
```

# 40. Добавить в репозиторий /etc

1. Создать `/etc/.gitignore`:
```
/ld.so.cache
```
2. Инициализировать репозиторий:
```
cd /etc
git init

git add .
git commit -m 'initial'
```
 
# 50. Добавить в репозиторий /usr/local/mgr5/etc

1. Создать `/usr/local/mgr5/etc/.gitignore`:
```
/ispmgr.db-shm
/ispmgr.db-wal
/ispmgr_dbsize.db-shm
/ispmgr_dbsize.db-wal
/gid.cache
/ispmgr.db
/ispmgr_dbsize.db
/uid.cache
# постоянно меняется, видимо, он каждый день лицензию обновляет
/ispmgr.lic
```
2. Инициализировать репозиторий:
```
cd /usr/local/mgr5/etc
git init

git add .
git commit -m 'initial'
```

# 60. Установить nginx

(на основе [этой инструкции](https://stackoverflow.com/c/itweb/questions/237/238))

Включаем nginx, чтобы он всегда сразу был, чтобы его потом не устанавливать при рабочих сайтах.

1. В ISPManager: Настройки -> Возможности -> Веб-сервер -> Изменить.
  * Включаем галочку Nginx,
  * Применяем,
  * Отключаем галочку Awstats (нельзя делать это вместе с включением nginx, иначе зависает),
  * Применяем.
2. Ждем завершения обновления конфигурации.

Готово. 

# 65. Включаем HTTP/2

(протокол HTTP/2 быстрее и поддержка должна быть включена везде по умолчанию).

(справочно: [требования ISPManager для включения](https://docs.ispsystem.ru/ispmanager-lite/nastrojki-veb-serverov/nastrojka-podderyoki-http-2))

1. Nginx у нас уже есть.
2. Поэтому идем Настройки web-сервера → Глобальные настройки.
3. Включаем галочку HTTP/2.
4. Нажимаем OK.

Поддержка включена.

теги: http2

# 70. Устанавливаем PHP

Сначала нужно определиться с версией PHP. Это очень важно, потому что на новом PHP не работает старый Битрикс (точно не помню, почему, вроде в php что-то запретили), а на старом PHP не работает новый Битрикс (тоже не помню, почему, возможно это был баг, потому что если на 7.1 обновить Битрикс 18 до версии 20, то все работает нормально).

 * Если версия Битрикса 20 и выше, ставим 7.4 по [этой инструкции](https://stackoverflow.com/c/itweb/a/329)
 * Если 19 и меньше - ставим 7.1 по [этой инструкции](https://stackoverflow.com/c/itweb/a/330)

# 80. Перезапускаем Apache

После установки PHP перезапускаем apache:

```
service apache2 reload
```

# 90. Оптимизация mysql под Битрикс

Делаем по [инструкции по настройке Mysql для Битрикс](https://stackoverflow.com/c/itweb/questions/255/256).

Для размещения используем файлы

1. `/etc/mysql/mariadb.conf.d/98-bitrix.cnf` - для корректной работы.
2. `/etc/mysql/mariadb.conf.d/98-tuning.cnf` - для производительности.

Перезапускаем mysql 

```
service mysql restart
```

# 100. Тесты

Тесты на этом этапе возможности сделать нет, так как для этого придется создавать сайт, а сайты мы в рамках данного шага не создаём.

# 110. Коммит конфигурации

1. Коммитим `/etc`
```
cd /etc
git add .
git commit -m 'первоначальная настройка по инструкции: https://stackoverflow.com/c/itweb/questions/80#81'
```
2. Коммитим `/usr/local/mgr5/etc`
```
cd /usr/local/mgr5/etc
git add .
git commit -m 'первоначальная настройка по инструкции: https://stackoverflow.com/c/itweb/questions/80#81'
```
3. Коммитим `/opt/php74/etc`
```
if [ -d /opt/php74/etc ] ; then cd /opt/php74/etc && git add . && git diff-index --quiet HEAD || git commit -m 'первоначальная настройка по инструкции: https://stackoverflow.com/c/itweb/questions/80#81' || echo -e "\n\n ** FAIL\n\n" >&2 ; else echo -e "\n -- PHP 7.4 is not installed\n" ; fi
```

Если написал FAIL, значит все плохо, если написал "not installed", значит просто эта версия PHP не установлена.

4. Коммитим `/opt/php71/etc`
```
if [ -d /opt/php71/etc ] ; then cd /opt/php71/etc && git add . && git diff-index --quiet HEAD || git commit -m 'первоначальная настройка по инструкции: https://stackoverflow.com/c/itweb/questions/80#81' || echo -e "\n\n ** FAIL\n\n" >&2 ; else echo -e "\n -- PHP 7.1 is not installed\n" ; fi
```

Если написал FAIL, значит все плохо, если написал "not installed", значит просто эта версия PHP не установлена.

